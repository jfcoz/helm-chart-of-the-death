---
# Source: helm-chart-of-the-death/templates/security/kyverno/helmrelease-policies.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kyverno-policies
  namespace: infra-kyverno
  annotations:
    helm.sh/resource-policy: keep
spec:
  dependsOn:
    - name: kyverno
      namespace: infra-kyverno
  interval: 1h
  timeout: 30m
  chart:
    spec:
      chart: kyverno-policies
      # each major contains upgrade process in changelog
      version: "3.6.2"
      sourceRef:
        kind: HelmRepository
        name: "kyverno"
        namespace: default
      interval: 1h
  install:
    crds: Create
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  test:
    enable: true
  values:
    debug:
      - disallow-capabilities
      - disallow-host-namespaces
      - disallow-host-path
      - disallow-host-ports
      - disallow-privileged-containers
      - restrict-sysctls
    failurePolicy: Ignore
    policyExclude:
      disallow-capabilities:
        any:
          - resources:
              kinds:
                - Pod
              names:
                - rook-ceph.cephfs.csi.ceph.com-nodeplugin*
                - rook-ceph.rbd.csi.ceph.com-nodeplugin*
              namespaces:
                - rook-ceph
      disallow-host-namespaces:
        any:
          - resources:
              namespaces:
                - rook-ceph
      disallow-host-path:
        any:
          - resources:
              namespaces:
                - rook-ceph
          - resources:
              kinds:
                - Pod
              names:
                - falco-*
                - infra-falco-falco-*
              namespaces:
                - infra-falco
      disallow-privileged-containers:
        any:
          - resources:
              namespaces:
                - rook-ceph
          - resources:
              kinds:
                - Pod
              names:
                - falco-*
                - infra-falco-falco-*
              namespaces:
                - infra-falco
    validationFailureAction: Enforce

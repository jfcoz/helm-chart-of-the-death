---
# Source: helm-chart-of-the-death/templates/monitoring/kube-prometheus-stack/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: prometheus
  namespace: infra-prometheus
  annotations:
    helm.sh/resource-policy: keep
spec:
  dependsOn:
    - name: thanos
      namespace: infra-thanos
  #  - name: ceph-cluster
  #    namespace: rook-ceph
  #  - name: nginx-ingress
  #    namespace: infra-nginx-ingress
  interval: 1h
  timeout: 10m
  chart:
    spec:
      chart: kube-prometheus-stack
      # each major contains upgrade process in changelog
      version: "82.0.2"
      sourceRef:
        kind: HelmRepository
        name: "prometheus-community"
        namespace: default
      interval: 1h
  install:
    crds: Create
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  test:
    enable: true
  values:
    additionalPrometheusRulesMap:
      rule-name:
        groups:
          - name: Flux
            rules:
              - alert: HelmReleaseNotReady
                annotations:
                  description: HelmRelease {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is in an unready state for more than 15 minutes.
                  summary: HelmRelease {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is not ready
                expr: gotk_resource_info{customresource_kind="HelmRelease", ready!="True"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: critical
              - alert: GitRepositorySyncFailed
                annotations:
                  description: GitRepository {{ $labels.name }} in namespace {{ $labels.exported_namespace }} has not been successfully synced for more than 15 minutes.
                  summary: GitRepository {{ $labels.name }} in namespace {{ $labels.exported_namespace }} sync failed
                expr: gotk_resource_info{customresource_kind="GitRepository", ready!="True"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: warning
              - alert: KustomizationNotApplied
                annotations:
                  description: Kustomization {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is not successfully applied for more than 15 minutes.
                  summary: Kustomization {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is not applied
                expr: gotk_resource_info{customresource_kind="Kustomization", ready!="True"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: critical
              - alert: ImageRepositorySyncFailed
                annotations:
                  description: ImageRepository {{ $labels.name }} in namespace {{ $labels.exported_namespace }} has not been successfully synced for more than 15 minutes.
                  summary: ImageRepository {{ $labels.name }} in namespace {{ $labels.exported_namespace }} sync failed
                expr: gotk_resource_info{customresource_kind="ImageRepository", ready!="True"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: warning
              - alert: HelmChartFailed
                annotations:
                  description: HelmChart {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is not ready for more than 15 minutes.
                  summary: HelmChart {{ $labels.name }} in namespace {{ $labels.exported_namespace }} has failed
                expr: gotk_resource_info{customresource_kind="HelmChart", ready!="True"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: warning
              - alert: HelmReleaseSuspended
                annotations:
                  description: HelmRelease {{ $labels.name }} in namespace {{ $labels.exported_namespace }} has been suspended.
                  summary: HelmRelease {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is suspended
                expr: gotk_resource_info{customresource_kind="HelmRelease", suspended="true"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: warning
              - alert: GitRepositorySuspended
                annotations:
                  description: GitRepository {{ $labels.name }} in namespace {{ $labels.exported_namespace }} has been suspended.
                  summary: GitRepository {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is suspended
                expr: gotk_resource_info{customresource_kind="GitRepository", suspended="true"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: warning
              - alert: KustomizationSuspended
                annotations:
                  description: Kustomization {{ $labels.name }} in namespace {{ $labels.exported_namespace }} has been suspended.
                  summary: Kustomization {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is suspended
                expr: gotk_resource_info{customresource_kind="Kustomization", suspended="true"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: warning
              - alert: ImageRepositorySuspended
                annotations:
                  description: ImageRepository {{ $labels.name }} in namespace {{ $labels.exported_namespace }} has been suspended.
                  summary: ImageRepository {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is suspended
                expr: gotk_resource_info{customresource_kind="ImageRepository", suspended="true"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: warning
              - alert: HelmChartSuspended
                annotations:
                  description: HelmChart {{ $labels.name }} in namespace {{ $labels.exported_namespace }} has been suspended.
                  summary: HelmChart {{ $labels.name }} in namespace {{ $labels.exported_namespace }} is suspended
                expr: gotk_resource_info{customresource_kind="HelmChart", suspended="true"} > 0
                for: 5m
                labels:
                  exported_instance: '{{ $labels.exported_namespace }}/{{ $labels.name }}'
                  service: fluxcd
                  severity: warning
          - name: Trivy
            rules:
              - alert: ImageScanJobBlocked
                annotations:
                  summary: '{{ $labels.job_name }} image scan job is finished but not removed after more than five minutes.'
                expr: sum by(job_name) (kube_job_complete{namespace="infra-trivy"})
                for: 5m
                labels:
                  severity: critical
          - name: Nodes
            rules:
              - expr: |-
                  avg by(node) (
                      avg by(internal_ip) (
                          label_replace(
                              avg by(instance) (instance:node_load1_per_cpu:ratio),
                              "internal_ip",
                              "$1",
                              "instance",
                              "([^:]+):.*"
                          )
                      )
                      * on(internal_ip) group_right
                      kube_node_info
                  )
                record: node:load1_per_cpu_ratio
              - alert: NodeLoadHigh5m
                annotations:
                  description: The load average on node {{ $labels.node }} is too high since too long
                  summary: Load per core > 16 for 5m on {{ $labels.node }}
                expr: |-
                  avg by(node) (
                      node:load1_per_cpu_ratio
                  ) > 16
                for: 5m
                labels:
                  severity: critical
              - alert: NodeLoadHigh15m
                annotations:
                  description: The load average on node {{ $labels.node }} is too high since too long
                  summary: Load per core > 8 for 15m on {{ $labels.node }}
                expr: |-
                  avg by(node) (
                      node:load1_per_cpu_ratio
                  ) > 8
                for: 15m
                labels:
                  severity: critical
              - alert: NodeLoadHigh30m
                annotations:
                  description: The load average on node {{ $labels.node }} is too high since too long
                  summary: Load per core > 4 for 30m on {{ $labels.node }}
                expr: |-
                  avg by(node) (
                      node:load1_per_cpu_ratio
                  ) > 4
                for: 30m
                labels:
                  severity: critical
              - alert: NodeLoadHigh120m
                annotations:
                  description: The load average on node {{ $labels.node }} is too high since too long
                  summary: Load per core > 1 for 120m on {{ $labels.node }}
                expr: |-
                  avg by(node) (
                      node:load1_per_cpu_ratio
                  ) > 1
                for: 120m
                labels:
                  severity: warning
              - alert: NodeMemoryHigh
                annotations:
                  description: The memory usage on node {{ $labels.node }} is too high. Free+cache is less than 10%
                  summary: Memory high on {{ $labels.node }}
                expr: |-
                  avg by(node) (
                      avg by(internal_ip) (
                          label_replace(
                              avg by(instance) (
                                  (node_memory_MemFree_bytes + node_memory_Cached_bytes) / node_memory_MemTotal_bytes
                              ),
                              "internal_ip",
                              "$1",
                              "instance",
                              "([^:]+):.*"
                          )
                      )
                      * on(internal_ip) group_right
                      kube_node_info
                  )
                  < 0.1
                for: 3m
                labels:
                  severity: critical
              - alert: NodeReboot
                annotations:
                  description: Node uptime on {{ $labels.node }} is less than one hour. Investigate reboot reason
                  summary: Node {{ $labels.node }} has rebooted
                expr: |-
                  avg by(node) (
                      avg by(internal_ip) (
                          label_replace(
                              avg by(instance) (
                                  (node_time_seconds{} - node_boot_time_seconds{})
                              ),
                              "internal_ip",
                              "$1",
                              "instance",
                              "([^:]+):.*"
                          )
                      )
                      * on(internal_ip) group_right
                      kube_node_info
                  )
                  < 3600
                for: 3m
                labels:
                  severity: critical
              - alert: CpuTemperatureWarning
                annotations:
                  description: Node CPU temperature on {{ $labels.node }} is more than 80% of limit
                  summary: Node CPU temperature warning on{{ $labels.node }}
                expr: |-
                  avg by(node) (
                      avg by(internal_ip) (
                          label_replace(
                              avg by(instance) (
                                  (node_hwmon_temp_celsius{} / node_hwmon_temp_crit_celsius{})
                              ),
                              "internal_ip",
                              "$1",
                              "instance",
                              "([^:]+):.*"
                          )
                      )
                      * on(internal_ip) group_right
                      kube_node_info
                  )
                  > 0.8
                for: 3m
                labels:
                  severity: warning
              - alert: CpuTemperatureCritical
                annotations:
                  description: Node CPU temperature on {{ $labels.node }} is more than 90% of limit
                  summary: Node CPU temperature warning on{{ $labels.node }}
                expr: |-
                  avg by(node) (
                      avg by(internal_ip) (
                          label_replace(
                              avg by(instance) (
                                  (node_hwmon_temp_celsius{} / node_hwmon_temp_crit_celsius{})
                              ),
                              "internal_ip",
                              "$1",
                              "instance",
                              "([^:]+):.*"
                          )
                      )
                      * on(internal_ip) group_right
                      kube_node_info
                  )
                  > 0.9
                for: 1m
                labels:
                  severity: critical
          - name: Resources
            rules:
              - alert: MemoryWorkingSetOverRequest
                annotations:
                  description: container {{ $labels.container }} of pod {{ $labels.pod }} in namespace{{ $labels.namespace }} have a memory working set (resident size, mapped files) upper to its memory request for too long. Please increase the memory request to avoir OOm killer in case of memory contention
                  summary: Memory working set vs request is too high
                expr: |-
                  (
                    sum by(container, namespace, pod) (container_memory_working_set_bytes)
                    /
                    sum by(container, namespace, pod) (kube_pod_container_resource_requests{resource="memory"})
                  ) > 1
                for: 30m
                labels:
                  severity: warning
              - alert: MemoryRssOverRequest
                annotations:
                  description: container {{ $labels.container }} of pod {{ $labels.pod }} in namespace{{ $labels.namespace }} have a memory RSS (resident size) 2 times upper to its memory request in last day. Please increase the memory request to avoir OOm killer in case of memory contention
                  summary: Memory usage vs request is too high
                expr: |-
                  (
                      sum by (namespace,pod,container) (kube_pod_container_resource_requests{resource="memory"})
                      -
                      sum by (namespace,pod,container) (container_memory_working_set_bytes{container!=""})
                      > 50*1024*1024
                  )
                  and
                  (
                      sum by (namespace,pod,container) (kube_pod_container_resource_requests{resource="memory"})
                      /
                      sum by (namespace,pod,container) (container_memory_working_set_bytes{container!=""})
                      > 2
                  )
                for: 24h
                labels:
                  severity: warning
              - alert: MissingMemoryRequest
                annotations:
                  description: container {{ $labels.container }} of pod {{ $labels.pod }} in namespace{{ $labels.namespace }} is missing a memory request. Please add the memory request to avoir OOm killer in case of memory contention
                  summary: Memory request is missing
                expr: |-
                  avg by(container,pod,namespace) (
                     container_memory_rss{container=~".+"}
                     unless on(container,pod,namespace)
                     kube_pod_container_resource_requests{resource="memory"} > 0
                  )
                for: 30m
                labels:
                  severity: warning
              - alert: CpuOverReservation
                annotations:
                  description: container {{ $labels.container }} of pod {{ $labels.pod }} in namespace{{ $labels.namespace }} is requesting 2 times more CPU than it\\s maximum usage in last day. Please reduce the cpu request to allow a better resource sharing
                  summary: CPU is over requested
                expr: |-
                  (
                      sum by (namespace, pod, container) (kube_pod_container_resource_requests{resource="cpu"})
                      -
                      sum by (namespace, pod, container) (rate(container_cpu_usage_seconds_total{image!=""}[1m]))
                      > 0.010
                  )
                  and
                  (
                      sum by (namespace, pod, container) (kube_pod_container_resource_requests{resource="cpu"})
                      /
                      sum by (namespace, pod, container) (rate(container_cpu_usage_seconds_total{image!=""}[1m]))
                      > 2
                  )
                for: 24h
                labels:
                  severity: warning
              - alert: CpuUnderReservation
                annotations:
                  description: container {{ $labels.container }} of pod {{ $labels.pod }} in namespace{{ $labels.namespace }} is requesting less CPU than it\\s maximum usage in last 24 hours. Please increase the cpu request to garantee resources allocation
                  summary: CPU is under requested
                expr: |-
                  sum by (namespace,pod,container) (kube_pod_container_resource_requests{resource="cpu"})
                  /
                  sum by (namespace,pod,container) (max_over_time(rate(container_cpu_usage_seconds_total{image!=""}[1m])[1d:]))
                  < 1
                for: 10m
                labels:
                  severity: warning
          - name: Upgrades
            rules:
              - alert: ApiserverRequestedDeprecatedApis
                annotations:
                  description: Apiserver receive requests for deprecated Apis. This must be corrected before next upgrade
                  summary: ApiserverRequestedDeprecatedApis
                expr: apiserver_requested_deprecated_apis > 0
                for: 1m
                labels:
                  severity: warning
          - name: Applications
            rules:
              - alert: ContainerRestartsTooMuch
                annotations:
                  description: The container {{ $labels.container }} of pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has restarted more than one time in tha last hour, please analyse the cause
                  summary: ContainerRestartsTooMuch
                expr: sum by(namespace,pod,container) (stdvar_over_time(kube_pod_container_status_restarts_total[1h])) > 1
                for: 1m
                labels:
                  severity: warning
              - alert: ContainerProbeIsFlapping
                annotations:
                  description: The {{ $labels.probe_type}} of container {{ $labels.container }} of pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is flapping, please check the application
                  summary: ContainerProbeIsFlapping
                expr: sum by(namespace, pod, container, probe_type) (stddev_over_time(prober_probe_total{result="failed",probe_type!="Startup"}[10m])) > 2
                for: 1m
                labels:
                  severity: warning
    alertmanager:
      alertmanagerSpec:
        replicas: 2
        resources:
          requests:
            cpu: 20m
            memory: 80M
        storage:
          volumeClaimTemplate:
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 2Gi
              storageClassName: ceph-block
        topologySpreadConstraints:
          - labelSelector:
              matchLabels:
                app: alertmanager
            maxSkew: 1
            topologyKey: topology.kubernetes.io/zone
            whenUnsatisfiable: DoNotSchedule
      config:
        inhibit_rules:
          - equal:
              - namespace
              - alertname
            source_matchers:
              - severity = critical
            target_matchers:
              - severity =~ warning|info
          - equal:
              - namespace
              - alertname
            source_matchers:
              - severity = warning
            target_matchers:
              - severity = info
          - equal:
              - namespace
            source_matchers:
              - alertname = InfoInhibitor
            target_matchers:
              - severity = info
        receivers:
          - name: "null"
          - name: Slack
            slack_configs:
              - api_url: https://example.com
                send_resolved: true
          - name: Watchdog
            webhook_configs:
              - url: https://example.com
          - name: OnCall
            webhook_configs:
              - send_resolved: true
                url: https://example.com
        route:
          group_by:
            - namespace
          receiver: "null"
          routes:
            - matchers:
                - alertname = "InfoInhibitor"
              receiver: "null"
            - group_interval: 1m
              group_wait: 0s
              matchers:
                - alertname = "Watchdog"
              receiver: Watchdog
              repeat_interval: 1m
            - matchers:
                - severity =~ "warning|info"
              receiver: "null"
            - matchers:
                - severity = "critical"
              receiver: OnCall
    customRules:
      KubeCPUOvercommit:
        severity: info
      KubeMemoryOvercommit:
        severity: info
    defaultRules:
      rules:
        kubeProxy: false
        kubeSchedulerAlerting: false
        kubeSchedulerRecording: false
    grafana:
      additionalDataSources:
        - access: proxy
          name: Loki
          type: loki
          url: http://loki-query-frontend.infra-loki:3100
        - access: proxy
          jsonData:
            implementation: prometheus
          name: alertmanager
          type: alertmanager
          url: http://{{ template "kube-prometheus-stack.fullname" . }}-alertmanager:9093
        - access: proxy
          jsonData:
            nodeGraph:
              enabled: true
            serviceMap:
              datasourceUid: prometheus
            tracesToLogsV2:
              datasourceUid: loki
            tracesToMetrics:
              datasourceUid: prometheus
          name: tempo
          type: tempo
          url: http://tempo-query-frontend.infra-tempo:3100
        - access: proxy
          name: thanos
          type: prometheus
          url: http://thanos-query.infra-thanos:10902
      adminPassword: change_me
      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
            - disableDeletion: true
              editable: false
              folder: ""
              name: default
              options:
                path: /var/lib/grafana/dashboards/default
              orgId: 1
              type: file
            - disableDeletion: true
              editable: false
              folder: FluxCD
              name: fluxcd
              options:
                path: /var/lib/grafana/dashboards/fluxcd
              orgId: 1
              type: file
            - disableDeletion: true
              editable: false
              folder: X509 certificate exporter
              name: x509-certificate-exporter
              options:
                path: /var/lib/grafana/dashboards/x509-certificate-exporter
              orgId: 1
              type: file
            - disableDeletion: true
              editable: false
              folder: Falco
              name: falco
              options:
                path: /var/lib/grafana/dashboards/falco
              orgId: 1
              type: file
            - disableDeletion: true
              editable: false
              folder: Ceph
              name: ceph
              options:
                path: /var/lib/grafana/dashboards/ceph
              orgId: 1
              type: file
            - disableDeletion: true
              editable: false
              folder: Trivy
              name: trivy
              options:
                path: /var/lib/grafana/dashboards/trivy
              orgId: 1
              type: file
      dashboards:
        ceph:
          ceph-application-overview:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/ceph-application-overview.json
          ceph-cluster:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/ceph-cluster.json
          ceph-cluster-advanced:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/ceph-cluster-advanced.json
          host-details:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/host-details.json
          hosts-overview:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/hosts-overview.json
          osd-device-details:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/osd-device-details.json
          osds-overview:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/osds-overview.json
          pool-detail:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/pool-detail.json
          pool-overview:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/pool-overview.json
          radosgw-detail:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/radosgw-detail.json
          radosgw-overview:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/radosgw-overview.json
          radosgw-sync-overview:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/radosgw-sync-overview.json
          rbd-details:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/rbd-details.json
          rbd-overview:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/dashboards_out/rbd-overview.json
        default:
          blackbox-exporter:
            datasource: Prometheus
            gnetId: 7587
            revision: 3
          ethtool:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/jfcoz/grafana-config/main/dashboards/ethtool.json
          kubernetes-compute-resources-cluster-capacity:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/jfcoz/grafana-config/main/dashboards/kubernetes_compute_resources_cluster_capacity.json
          kubernetes-velero:
            datasource: Prometheus
            gnetId: 11055
            revision: 2
          kyverno:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/kyverno/kyverno/main/charts/kyverno/charts/grafana/dashboard/kyverno-dashboard.json
          nginx-ingress:
            url: https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/grafana/dashboards/nginx.json
          node-exporter-full:
            datasource: Prometheus
            gnetId: 1860
            revision: 29
          popeye:
            datasource:
              - name: DS_PROMETHEUS
                value: Prometheus
            url: https://raw.githubusercontent.com/jfcoz/popeye/grafana-dashboard/grafana/popeye-dashboard.json
          varnish-kube-httpcache:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/jfcoz/grafana-config/main/dashboards/varnish_kube_httpcache.json
        falco:
          falco-dashboard:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/falcosecurity/charts/refs/heads/master/charts/falco/dashboards/falco-dashboard.json
        fluxcd:
          cluster:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/fluxcd/flux2-monitoring-example/refs/heads/main/monitoring/configs/dashboards/cluster.json
          control-plane:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/fluxcd/flux2-monitoring-example/refs/heads/main/monitoring/configs/dashboards/control-plane.json
          logs:
            datasource: Loki
            url: https://raw.githubusercontent.com/fluxcd/flux2-monitoring-example/refs/heads/main/monitoring/configs/dashboards/logs.json
        trivy:
          trivy-image-scan:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/jfcoz/grafana-config/main/dashboards/trivy_image_scan.json
        x509-certificate-exporter:
          x509-certificate-exporter:
            datasource: Prometheus
            gnetId: 13922
            revision: 3
      deploymentStrategy:
        type: Recreate
      grafana.ini:
        database:
          wal: true
        server:
          root_url: https://grafana.replaced.by.kustomization
      ingress:
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-production
        enabled: true
        hosts:
          - grafana.replaced.by.kustomization
        ingressClassName: nginx
        tls:
          - hosts:
              - grafana.replaced.by.kustomization
            secretName: grafana-general-tls
      persistence:
        enabled: true
        size: 1Gi
        storageClassName: ceph-block
      plugins:
        - grafana-piechart-panel
      resources:
        requests:
          memory: 150Mi
      sidecar:
        resources:
          requests:
            memory: 80Mi
    kube-state-metrics:
      customResourceState:
        config:
          spec:
            resources:
              - groupVersionKind:
                  group: kustomize.toolkit.fluxcd.io
                  kind: Kustomization
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux Kustomization resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      revision:
                        - status
                        - lastAppliedRevision
                      source_name:
                        - spec
                        - sourceRef
                        - name
                      suspended:
                        - spec
                        - suspend
                    name: resource_info
              - groupVersionKind:
                  group: helm.toolkit.fluxcd.io
                  kind: HelmRelease
                  version: v2
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux HelmRelease resource.
                    labelsFromPath:
                      chart_app_version:
                        - status
                        - history
                        - "0"
                        - appVersion
                      chart_name:
                        - status
                        - history
                        - "0"
                        - chartName
                      chart_ref_name:
                        - spec
                        - chartRef
                        - name
                      chart_source_name:
                        - spec
                        - chart
                        - spec
                        - sourceRef
                        - name
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      revision:
                        - status
                        - history
                        - "0"
                        - chartVersion
                      suspended:
                        - spec
                        - suspend
                    name: resource_info
              - groupVersionKind:
                  group: source.toolkit.fluxcd.io
                  kind: GitRepository
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux GitRepository resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      revision:
                        - status
                        - artifact
                        - revision
                      suspended:
                        - spec
                        - suspend
                      url:
                        - spec
                        - url
                    name: resource_info
              - groupVersionKind:
                  group: source.toolkit.fluxcd.io
                  kind: Bucket
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux Bucket resource.
                    labelsFromPath:
                      bucket_name:
                        - spec
                        - bucketName
                      endpoint:
                        - spec
                        - endpoint
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      revision:
                        - status
                        - artifact
                        - revision
                      suspended:
                        - spec
                        - suspend
                    name: resource_info
              - groupVersionKind:
                  group: source.toolkit.fluxcd.io
                  kind: HelmRepository
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux HelmRepository resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      revision:
                        - status
                        - artifact
                        - revision
                      suspended:
                        - spec
                        - suspend
                      url:
                        - spec
                        - url
                    name: resource_info
              - groupVersionKind:
                  group: source.toolkit.fluxcd.io
                  kind: HelmChart
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux HelmChart resource.
                    labelsFromPath:
                      chart_name:
                        - spec
                        - chart
                      chart_version:
                        - spec
                        - version
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      revision:
                        - status
                        - artifact
                        - revision
                      suspended:
                        - spec
                        - suspend
                    name: resource_info
              - groupVersionKind:
                  group: source.toolkit.fluxcd.io
                  kind: OCIRepository
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux OCIRepository resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      revision:
                        - status
                        - artifact
                        - revision
                      suspended:
                        - spec
                        - suspend
                      url:
                        - spec
                        - url
                    name: resource_info
              - groupVersionKind:
                  group: notification.toolkit.fluxcd.io
                  kind: Alert
                  version: v1beta3
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux Alert resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      suspended:
                        - spec
                        - suspend
                    name: resource_info
              - groupVersionKind:
                  group: notification.toolkit.fluxcd.io
                  kind: Provider
                  version: v1beta3
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux Provider resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      suspended:
                        - spec
                        - suspend
                    name: resource_info
              - groupVersionKind:
                  group: notification.toolkit.fluxcd.io
                  kind: Receiver
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux Receiver resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      suspended:
                        - spec
                        - suspend
                      webhook_path:
                        - status
                        - webhookPath
                    name: resource_info
              - groupVersionKind:
                  group: image.toolkit.fluxcd.io
                  kind: ImageRepository
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux ImageRepository resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      image:
                        - spec
                        - image
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      suspended:
                        - spec
                        - suspend
                    name: resource_info
              - groupVersionKind:
                  group: image.toolkit.fluxcd.io
                  kind: ImagePolicy
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux ImagePolicy resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      source_name:
                        - spec
                        - imageRepositoryRef
                        - name
                      suspended:
                        - spec
                        - suspend
                    name: resource_info
              - groupVersionKind:
                  group: image.toolkit.fluxcd.io
                  kind: ImageUpdateAutomation
                  version: v1
                metricNamePrefix: gotk
                metrics:
                  - each:
                      info:
                        labelsFromPath:
                          name:
                            - metadata
                            - name
                      type: Info
                    help: The current state of a Flux ImageUpdateAutomation resource.
                    labelsFromPath:
                      exported_namespace:
                        - metadata
                        - namespace
                      ready:
                        - status
                        - conditions
                        - '[type=Ready]'
                        - status
                      source_name:
                        - spec
                        - sourceRef
                        - name
                      suspended:
                        - spec
                        - suspend
                    name: resource_info
        enabled: true
      metricLabelsAllowlist:
        - nodes=[topology.kubernetes.io/region,topology.kubernetes.io/zone]
      rbac:
        extraRules:
          - apiGroups:
              - source.toolkit.fluxcd.io
              - kustomize.toolkit.fluxcd.io
              - helm.toolkit.fluxcd.io
              - notification.toolkit.fluxcd.io
              - image.toolkit.fluxcd.io
            resources:
              - gitrepositories
              - buckets
              - helmrepositories
              - helmcharts
              - ocirepositories
              - kustomizations
              - helmreleases
              - alerts
              - providers
              - receivers
              - imagerepositories
              - imagepolicies
              - imageupdateautomations
            verbs:
              - list
              - watch
      replicas: 2
      resources:
        limits:
          memory: 200Mi
        requests:
          cpu: 30m
          memory: 150Mi
    kubeControllerManager:
      enabled: false
    prometheus:
      prometheusSpec:
        enableRemoteWriteReceiver: true
        externalLabels:
          cluster: change_me
        maximumStartupDurationSeconds: 900
        podMonitorSelectorNilUsesHelmValues: false
        probeSelectorNilUsesHelmValues: false
        replicas: 1
        resources:
          limits:
            memory: 3Gi
          requests:
            cpu: 800m
            memory: 3Gi
        ruleSelectorNilUsesHelmValues: false
        serviceMonitorSelectorNilUsesHelmValues: false
        storageSpec:
          volumeClaimTemplate:
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 20Gi
              storageClassName: ceph-block
        thanos:
          objectStorageConfig:
            secret:
              config:
                access_key: '{{ (((lookup "v1" "Secret" "infra-thanos" "thanos-bucket").data).AWS_ACCESS_KEY_ID) | default "bucket secret is not yet available" | b64dec }}'
                bucket: thanos-bucket
                bucket_lookup_type: path
                endpoint: rook-ceph-rgw-ceph-objectstore.rook-ceph.svc
                insecure: true
                region: rook
                secret_key: '{{ (((lookup "v1" "Secret" "infra-thanos" "thanos-bucket").data).AWS_SECRET_ACCESS_KEY) | default "bucket secret is not yet available" | b64dec }}'
              type: S3
        topologySpreadConstraints:
          - labelSelector:
              matchLabels:
                app: prometheus
            maxSkew: 1
            topologyKey: topology.kubernetes.io/zone
            whenUnsatisfiable: DoNotSchedule
      thanosService:
        enabled: true
      thanosServiceMonitor:
        enabled: true
    prometheus-node-exporter:
      extraArgs:
        - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/.+)($|/)
        - --collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$
        - --collector.ethtool
        - --collector.ethtool.device-exclude="^(brq|tap|veth|vxlan|virbr|usb).*$"
      resources:
        requests:
          cpu: 20m
          memory: 25M
    prometheusOperator:
      prometheusConfigReloader:
        resources:
          limits:
            cpu: 500m
            memory: 50Mi
          requests:
            cpu: 1m
            memory: 30Mi
      resources:
        limits:
          cpu: 1000m
          memory: 400Mi
        requests:
          cpu: 0m
          memory: 40Mi
  postRenderers:
    - kustomize:
        ##replace severity warning by critical on KubePodCrashLooping
        #patchesStrategicMerge:
        #- kind: PrometheusRule
        #  apiVersion: monitoring.coreos.com/v1
        #  metadata:
        #    name: prometheus-kube-prometheus-kubernetes-apps
        #    namespace: infra-prometheus
        #  spec:
        #    groups:
        #    - $patch: merge
        #      name: kubernetes-apps
        #      rules:
        #      - $patch: merge
        #        alert: KubePodCrashLooping
        #        labels:
        #          severity: critical
        patches:
          - target:
              version: v1
              kind: PrometheusRule
              name: prometheus-kube-prometheus-kubernetes-apps
            patch: |
              # TODO: when possible, identify rule by name. until that we test to check if source rule has change
              # test: check if the specified node has the specified value, if the value differs it will throw an error
              - op: test
                path: /spec/groups/0/name
                value: "kubernetes-apps"
              - op: test
                path: /spec/groups/0/rules/0/alert
                value: "KubePodCrashLooping"
              - op: replace
                path: /spec/groups/0/rules/0/labels/severity
                value: critical

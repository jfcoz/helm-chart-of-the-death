---
# Source: helm-chart-of-the-death/templates/monitoring/tempo/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tempo
  namespace: infra-tempo
  annotations:
    helm.sh/resource-policy: keep
spec:
  #dependsOn:
  #  - name: prometheus
  #    namespace: infra-prometheus
  interval: 1h
  timeout: 5m
  install:
    crds: Create
  upgrade:
    crds: CreateReplace
    remediation:
      remediateLastFailure: true
  chart:
    spec:
      chart: tempo-distributed
      version: "2.4.2"
      sourceRef:
        kind: HelmRepository
        name: "grafana-community"
        namespace: default
      interval: 1h
  test:
    enable: true
  values:
    compactor:
      config:
        compaction:
          block_retention: 2h
      resources:
        limits:
          memory: 3Gi
        requests:
          memory: 200Mi
    distributor:
      resources:
        limits:
          memory: 150Mi
        requests:
          memory: 150Mi
    ingester:
      autoscaling:
        enabled: true
        targetCPUUtilizationPercentage: 90
      config:
        replication_factor: 1
      persistence:
        claims:
          - name: data
            size: 10Gi
            storageClass: ceph-block
        enabled: true
        labels:
          velero.io/exclude-from-backup: "true"
      replicas: 1
      resources:
        limits:
          memory: 1000Mi
        requests:
          cpu: 20m
          memory: 500Mi
    memcached:
      resources:
        limits:
          memory: 50Mi
        requests:
          memory: 2Mi
    metaMonitoring:
      serviceMonitor:
        enabled: true
    metricsGenerator:
      enabled: true
      remote_write:
        - url: http://http://prometheus-kube-prometheus-prometheus.infra-prometheus:9090/api/v1/write
    prometheusRule:
      enabled: true
    querier:
      resources:
        limits:
          memory: 500Mi
        requests:
          memory: 100Mi
    queryFrontend:
      resources:
        limits:
          memory: 100Mi
        requests:
          memory: 70Mi
    storage:
      trace:
        backend: s3
        s3:
          access_key: '{{ (((lookup "v1" "Secret" "infra-tempo" "tempo-bucket").data).AWS_ACCESS_KEY_ID) | default "QnVja2V0U2VjcmV0Tm90QXZhaWxhYmxlWWV0" | b64dec }}'
          bucket: tempo-bucket
          endpoint: rook-ceph-rgw-ceph-objectstore.rook-ceph.svc
          insecure: true
          region: rook
          secret_key: '{{ (((lookup "v1" "Secret" "infra-tempo" "tempo-bucket").data).AWS_SECRET_ACCESS_KEY) | default "QnVja2V0U2VjcmV0Tm90QXZhaWxhYmxlWWV0" | b64dec }}'
    traces:
      otlp:
        grpc:
          enabled: true

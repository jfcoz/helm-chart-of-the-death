---
# Source: helm-chart-of-the-death/templates/monitoring/x509-certificate-exporter/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: x509
  namespace: infra-x509
  annotations:
    helm.sh/resource-policy: keep
spec:
  dependsOn:
    - name: prometheus
      namespace: infra-prometheus
  interval: 1h
  timeout: 30m
  chart:
    spec:
      chart: x509-certificate-exporter
      version: "3.19.1"
      sourceRef:
        kind: HelmRepository
        name: "enix"
        namespace: default
      interval: 1h
  install:
    remediation:
      retries: -1
  upgrade:
    remediation:
      remediateLastFailure: true
  test:
    enable: true
  values:
    hostPathsExporter:
      daemonSets:
        masters:
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node-role.kubernetes.io/control-plane
                        operator: In
                        values:
                          - "true"
          tolerations:
            - effect: NoSchedule
              key: master
              operator: Exists
          watchDirectories:
            - /var/lib/rancher/k3s/server/tls/
            - /var/lib/rancher/k3s/agent/
        nodes:
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node-role.kubernetes.io/control-plane
                        operator: NotIn
                        values:
                          - "true"
          tolerations:
            - effect: NoSchedule
              key: storage
              operator: Exists
          watchDirectories:
            - /var/lib/rancher/k3s/agent/
      resources:
        limits:
          cpu: 1000m
          memory: 30M
        requests:
          cpu: 1m
          memory: 30M
    prometheusRules:
      create: true
    prometheusServiceMonitor:
      create: true
    secretsExporter:
      cache:
        maxDuration: 600
      resources:
        limits:
          cpu: 1000m

---
# Source: helm-chart-of-the-death/templates/security/kyverno/helmrelease-policies.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kyverno-policies
  namespace: infra-kyverno
  annotations:
    helm.sh/resource-policy: keep
spec:
  dependsOn:
    - name: kyverno
      namespace: infra-kyverno
  interval: 1h
  timeout: 30m
  chart:
    spec:
      chart: kyverno-policies
      # each major contains upgrade process in changelog
      version: "3.6.2"
      sourceRef:
        kind: HelmRepository
        name: "kyverno"
        namespace: default
      interval: 1h
  install:
    crds: Create
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  test:
    enable: true
  values:
    debug:
      - disallow-host-path
      - disallow-host-ports
      - disallow-privileged-containers
      - disallow-selinux
      - restrict-seccomp
      - restrict-sysctls
      - disallow-capabilities
      - disallow-host-namespaces
      - other
    failurePolicy: Ignore
    policyExclude:
      disallow-capabilities:
        any:
          - resources:
              kinds:
                - Pod
              names:
                - cilium-*
                - cilium-envoy-*
              namespaces:
                - kube-system
          - resources:
              kinds:
                - Pod
              names:
                - rook-ceph.cephfs.csi.ceph.com-nodeplugin*
                - rook-ceph.rbd.csi.ceph.com-nodeplugin*
              namespaces:
                - rook-ceph
          - resources:
              kinds:
                - Pod
              names:
                - k8s-monitoring-alloy-logs-*
              namespaces:
                - infra-k8s-monitoring
          - resources:
              kinds:
                - Pod
              names:
                - svclb-nginx-ingress-ingress-nginx-controller-*
              namespaces:
                - kube-system
      disallow-host-namespaces:
        any:
          - resources:
              kinds:
                - Pod
              names:
                - cilium-*
              namespaces:
                - kube-system
          - resources:
              namespaces:
                - rook-ceph
          - resources:
              namespaces:
                - infra-prometheus
          - resources:
              kinds:
                - Pod
              names:
                - node-collector-*
              namespaces:
                - infra-trivy
          - resources:
              namespaces:
                - infra-smartctl-exporter
      disallow-host-path:
        any:
          - resources:
              kinds:
                - Pod
              names:
                - cilium-*
              namespaces:
                - kube-system
          - resources:
              namespaces:
                - rook-ceph
          - resources:
              kinds:
                - Pod
              namespaces:
                - infra-promtail
          - resources:
              kinds:
                - Pod
              namespaces:
                - infra-x509
          - resources:
              kinds:
                - Pod
              names:
                - k8s-monitoring-alloy-logs-*
              namespaces:
                - infra-k8s-monitoring
          - resources:
              kinds:
                - DaemonSet
              names:
                - prometheus-prometheus-node-exporter
              namespaces:
                - infra-prometheus
          - resources:
              kinds:
                - Pod
              names:
                - prometheus-prometheus-node-exporter-*
              namespaces:
                - infra-prometheus
          - resources:
              kinds:
                - Pod
              names:
                - node-collector-*
              namespaces:
                - infra-trivy
          - resources:
              namespaces:
                - infra-smartctl-exporter
          - resources:
              kinds:
                - Pod
              names:
                - node-agent-*
                - velero-*
              namespaces:
                - infra-velero
          - resources:
              kinds:
                - Pod
              names:
                - falco-*
                - infra-falco-falco-*
              namespaces:
                - infra-falco
          - resources:
              kinds:
                - Pod
              names:
                - example-*
              namespaces:
                - example
      disallow-host-ports:
        any:
          - resources:
              kinds:
                - Pod
              names:
                - cilium-*
                - cilium-envoy-*
                - cilium-operator-*
              namespaces:
                - kube-system
          - resources:
              kinds:
                - DaemonSet
              names:
                - prometheus-prometheus-node-exporter
              namespaces:
                - infra-prometheus
          - resources:
              kinds:
                - Pod
              names:
                - prometheus-prometheus-node-exporter-*
              namespaces:
                - infra-prometheus
          - resources:
              kinds:
                - Pod
              names:
                - svclb-nginx-ingress-ingress-nginx-controller-*
              namespaces:
                - kube-system
          - resources:
              namespaces:
                - infra-smartctl-exporter
      disallow-privileged-containers:
        any:
          - resources:
              kinds:
                - Pod
              names:
                - cilium-*
              namespaces:
                - kube-system
          - resources:
              namespaces:
                - rook-ceph
          - resources:
              namespaces:
                - infra-smartctl-exporter
          - resources:
              kinds:
                - Pod
              names:
                - falco-*
                - infra-falco-falco-*
              namespaces:
                - infra-falco
      disallow-selinux:
        any:
          - resources:
              kinds:
                - Daemonset
              names:
                - cilium
              namespaces:
                - kube-system
          - resources:
              kinds:
                - Pod
              names:
                - cilium-*
                - cilium-envoy-*
              namespaces:
                - kube-system
      other:
        any:
          - useless: true
      restrict-seccomp:
        any:
          - resources:
              kinds:
                - DaemonSet
              names:
                - cilium
              namespaces:
                - kube-system
          - resources:
              kinds:
                - Pod
              names:
                - cilium-*
              namespaces:
                - kube-system
      restrict-sysctls:
        any:
          - resources:
              kinds:
                - Pod
                - DaemonSet
              names:
                - svclb-nginx-ingress-ingress-nginx-controller-*
              namespaces:
                - kube-system
    validationFailureAction: Enforce

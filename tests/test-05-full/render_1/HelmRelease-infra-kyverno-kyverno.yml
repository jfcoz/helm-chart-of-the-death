---
# Source: helm-chart-of-the-death/templates/security/kyverno/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kyverno
  namespace: infra-kyverno
  annotations:
    helm.sh/resource-policy: keep
spec:
  #dependsOn:
  #  - name: ceph-cluster
  #    namespace: rook-ceph
  #  - name: nginx-ingress
  #    namespace: infra-nginx-ingress
  interval: 1h
  timeout: 30m
  chart:
    spec:
      chart: kyverno
      # each major contains upgrade process in changelog
      version: "3.6.2"
      sourceRef:
        kind: HelmRepository
        name: "kyverno"
        namespace: default
      interval: 1h
  install:
    crds: Create
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  test:
    enable: true
  values:
    admissionController:
      replicas: 3
      tolerations:
        - key: storage
          operator: Exists
          effect: NoSchedule
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app.kubernetes.io/instance: "all-in-one"
              app.kubernetes.io/component: admission-controller
      serviceMonitor:
        enabled: true
      networkPolicy:
        enabled: true
      container:
        resources:
          requests:
            cpu: 100m
            memory: 150M
          limits:
            memory: 150M
    backgroundController:
      resources:
        requests:
          cpu: 1m
    cleanupController:
      resources:
        requests:
          cpu: 1m
    reportsController:
      resources:
        requests:
          cpu: 1m
          memory: 100Mi
        limits:
          memory: 200Mi
    features:
      omitEvents:
        eventTypes:
          - PolicyApplied
    test:
      sleep: 1
    config:
      webhooks:
        # Exclude system namespaces, cf https://cloud.google.com/kubernetes-engine/docs/how-to/optimize-webhooks?hl=fr#unsafe-webhooks
        namespaceSelector:
          matchExpressions:
            - key: kubernetes.io/metadata.name
              operator: NotIn
              values:
                - kube-system
                - kube-node-lease

{{- $me := .Values.components.security.kyverno }}
{{- if include "common.managed" $me }}
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kyverno
  namespace: {{ $me.namespace }}
  annotations:
    {{- if $me.helmResourcePolicyKeep }}
    helm.sh/resource-policy: keep
    {{- end }}
spec:
  #dependsOn:
  #  - name: ceph-cluster
  #    namespace: rook-ceph
  #  - name: nginx-ingress
  #    namespace: infra-nginx-ingress
  interval: 1h
  timeout: 30m
  chart:
    spec:
      chart: kyverno
      # each major contains upgrade process in changelog
      version: {{ $me.chartVersion | quote }}
      sourceRef:
        kind: HelmRepository
        name: {{ $me.chartRepository | quote }}
        namespace: {{ $.Release.Namespace }}
      interval: 1h
  install:
    crds: Create
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  test:
    enable: true
  values:
    admissionController:
      replicas: 3
      tolerations:
      - key: storage
        operator: Exists
        effect: NoSchedule
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app.kubernetes.io/instance: "{{ .Release.Name }}"
              app.kubernetes.io/component: admission-controller
      serviceMonitor:
        enabled: true
      networkPolicy:
        enabled: true
      container:
        resources:
          requests:
            cpu: 100m
            memory: 150M
          limits:
            memory: 150M
    backgroundController:
      resources:
        requests:
          cpu: 1m
    cleanupController:
      resources:
        requests:
          cpu: 1m
    reportsController:
      resources:
        requests:
          cpu: 1m
          memory: 100Mi
        limits:
          memory: 200Mi
    features:
      omitEvents:
        eventTypes:
          - PolicyApplied
    test:
      sleep: 1
    config:
      webhooks:
        # Exclude system namespaces, cf https://cloud.google.com/kubernetes-engine/docs/how-to/optimize-webhooks?hl=fr#unsafe-webhooks
        namespaceSelector:
          matchExpressions:
          - key: kubernetes.io/metadata.name
            operator: NotIn
            values:
              - kube-system
              - kube-node-lease
{{- end }}
